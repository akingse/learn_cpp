## 碰撞检测



常用的侵入距离算法包括球体切剖法、点对距离法、基于凸壳的方法等。

符号距离场

### GJK算法

GJK算法是由 Gilbert,johnson和 Keerthi 3人在1988年共同开发的一类迭代算法。GJK算法的输入为两物体的顶点集，通过有限次数的迭代后，最后输出结果为两物体之间的欧氏距离。根据两物体之间 的欧氏距离，可进行碰撞检测。当两物体之间的距离等于或者小于零时，可判定两物体发生碰撞。

### 包围盒

### OBB包围盒



### AABB包围盒

AABB包围盒(Axis-Aligned Bounding Box) 是一种简单的包围体,它使用两个点来表示一个轴对齐的矩形区域。
AABB包围盒具有以下特点:

1. 两个点分别表示包围盒的最小点(min)和最大点(max)。
2. 包围盒的边界与坐标轴的方向一致,边界线与坐标轴之间的夹角为90度。因此AABB包围盒也称作坐标轴对齐的包围盒。
3. AABB包围盒简单易构造,Checking是否包含某点的计算量小。所以非常适合用于快速碰撞检测等。
4. 能够很好地近似许多物体的外形,具有一定的适用性。
5. 当物体发生平移、缩放变换时,AABB包围盒也可以很简单地进行相应变换。
   AABB包围盒经常用于3D空间中的物体包围和碰撞检测。
   其中蓝色点表示包围盒的8个顶点,红色点表示包围盒的最小点min和最大点max。
   所以,简而言之,AABB包围盒是一种简单的包围盒,它使用两个轴对齐的点来表示包围区域,广泛用于3D物体包围和碰撞检测领域。



### 快速求交

两个AABB包围盒的集合，想要快速求出它们相交的部分，你可以考虑使用空间分割数据结构，例如kd-tree或octree。这些数据结构可以将空间划分成不同的块或箱子，以有效地提高搜索和查询速度。



### 平面扫面算法

平面扫面算法是一种广泛用于3D环境中的碰撞检测和物体间相交计算的算法。它的基本思想是:

1. 将3D空间划分为多个平面,每个平面上放置一组物体或物体的包围体(通常是AABB包围盒)。
2. 选择一个轴(通常是y轴或z轴),沿着该轴方向逐渐"扫过"每个平面。
3. 在扫过每个平面时,检测该平面上的物体或包围体之间是否有碰撞或相交。
4. 通过扫面顺序,我们只需要在相邻平面之间检测碰撞,这减少了整个3D空间的碰撞检测量。
5. 由于物体只在某个平面上移动,所以我们可以通过追踪物体在上一平面上的状态来预测并优化当前平面上的碰撞检测。
   这个算法的优点是:
6. 将3D碰撞检测问题转换为2D,降低了计算复杂度。
7. 采用增量式检测,避免重复检测,提高效率。
8. 可预测并优化相邻平面之间的碰撞检测。
9. 空间上的连续物体,在平面扫面过程中也是连续的,这有利于相交计算。
   它的基本实现过程是:
10. 定义平面和轴,初始化平面上的物体和包围体。
11. 选择第一个平面,检测平面上的碰撞和相交。
12. 移动到下一个平面,预测并优化与上一平面碰撞相关的检测。同时检测新产生的碰撞。
13. 重复步骤3,逐层扫过每个平面。
14. 所有平面扫过后结束,得到最终的碰撞和相交结果。






### 数据结构

kd树

R-tree

[tree](https://zhuanlan.zhihu.com/p/32300891)

---

### PQP-TriDist

两个polyface求最小距离（三角面片求交）

[pqp](https://gamma.cs.unc.edu/SSV/)

邻近查询包 Proximity Query Package

   * collision detection - detect whether two models overlap, and
                           optionally, which triangles of the models  overlap. 是否碰撞，具体到三角面片
                          
   * distance computation - compute the distance between two models, 
                            i. e., the length of the shortest translation  that makes the models overlap 距离计算，最近距离
                           
   * tolerance verification - detect whether two models are closer or
                              farther than a tolerance value. 公差验证，距离与公差值比较



### paper

基于rssobb混合层次包围盒精确碰撞检测研究

计算三角形之间的精确距离以及确切的碰撞位置。与上文计算长方形之间距离相似，两个三角形之间的最近点,或者落在角形边上,或者在三角形内部。三角形边与边之间的距离运算同样用到Gilbert算法;三角形顶点与三角形面之间的距离则需要精确计算。

a fast procedure for computing the distance between complex object in 3d space

On fast computation of distance between line segments.

- 两个线段之间的最小距离；Gilbert
- 三角形顶点到三角形面之间的距离；

估计凸多面体间穿透深度的双空间展开——gamma团队

我们提出了一种增量算法来估计三维凸多面体之间的穿透深度。该算法通过在Minkowski和的表面上行走来逐步寻求“局部最优解”。Minkowski和的曲面是通过构造局部高斯映射来隐式计算的。在实践中，当环境中存在高运动相干时，该算法工作良好，并且在大多数情况下能够计算最优解。



### 穿透深度

penetration depth (PD) 穿透深度 (PD) 定义为使两个多面体的内部不相交的最小平移距离。

interpenetration



### lMinkowski Sum and Minkowski Difference

如果两个凸多边形有重叠部分，则它们的Minkowski sums也会存在一个包含原点的重叠区域。因此，在计算Minkowski sums时，我们通常将其中一个凸多边形反转一下（即取相反数），这样它的形状就成为了原凸多边形包围盒（Axis-Aligned Bounding Box或AABB）。然后我们将该AABB和另一个凸多边形作为输入，求出它们的Minkowski sums，并判断是否包含原点。

如果结果包含原点，则说明两个凸多边形之间存在重叠部分，即发生了碰撞。否则它们不重叠，即没有碰撞。



设平面图的顶点数、边数 和区域数分别为 v，e 和 f，则由欧拉公式有 v-e+f=2。

四面体，4-6+4

六面体 8-12+6



### 算法的局限性

 Dual-space Expansion for Estimating Penetration depth between convex polytopes 估计凸多面体间穿透深度的双空间展开

lMinkowski Sum 复杂度太大



当问题变得复杂时候，解决方案就会变得学术，论文很难啃，学术论文背后有很多专业的概念，比如闵可夫斯基和，还有一些作者自己定的概念，比如RSS(矩形扫掠球)，看懂论文，分析解决方案可行性，再到写实现，有很长的路要走；





---

## BV

往往包裹性越好的BV，相交测试越复杂，但是包裹性好可以减少相交测试的次数。

BVH建树困难也就意味着这个技术不适合运行时期动态更新。BVH和BSP一样往往是在非运行时期对静态物体进行预计算。

性能测试公式揭示了碰撞性能的消耗：
$$
T = NvCv + NpCp + NuCu + Co
$$
Nv是相交测试BV的数量，Cv是每次相交测试的消耗，Np是相交测试图元的数量，Cp是每次相交测试的消耗，Nu是需要更新节点的数量，Cu是更新节点的消耗，Co是一个常量消耗。

### BVH 层次包围盒(Bounding Volume Hierarchy)

BVH的核心思想就是用体积略大而几何特征简单的包围盒来近似描述复杂的几何对象，并且这种包围盒是嵌套的，我们只需要对包围盒进行进一步的相交测试，就可以越来越逼近实际对象（很明显这个功能需要用到树形的层次结构）。

![img](https://pic4.zhimg.com/80/v2-5bff610798835ab95d23a5a591e47ccb_1440w.webp)



### OBB包围盒

Oriented Bounding Box

用包围球做第一回合的快速测试，用OBB进行第二回合的测试。第一回合的测试可以剔除大多数不可见或不必裁剪的物体，这样不必进行第二回合测试的几率就会大得多。同时，OBB包围盒测试所得的结果更精确，最终要绘制的物体会更少。这种混合式的包围盒也适用于其他方面，如碰撞检测、物理/力学等

要计算两个OBB是否碰撞，只需要计算他们在图3上的4个坐标轴上的投影是否有重叠，如果有，则两多边形有接触。

判定方式：两个多边形在所有轴上的投影都发生重叠，则判定为碰撞；否则，没有发生碰撞。

OBB存在多种的表达方式，（二维）最常用的一种：一个中心点、2个矩形的边长、两个旋转轴（该轴垂直于多边形自身的边，用于投影计算）

OBB树





---



**kd-tree搜索**

kd-tree（k-dimensional树的简称），是一种对k维空间中的实例点进行存储以便对其进行快速检索的树形数据结构。 [1] 主要应用于多维空间关键数据的搜索（如：范围搜索和最近邻搜索）。K-D树是二进制空间分割树的特殊的情况。





### 体素化

三维像素化（pixel）

体素(Voxel)



平面三角形的像素化采样方法，也可以看作是三角面片与平面包围盒的求交算法，基于三角面片的求交算法也可以完成3D图形的体素化。基于空间采样的方式划分3维体素数组，使用三角形与空间AABB包围盒的求交算法确定这些基本体元所能影响到的体素单元，将这些体素标记为非空，这样就完成了对3D模型表面的体素化操作。对于内部的体素化，计算三角形到体素化网格中心点的距离，设定阈值进行判断。





### 分离轴定理

- 分离轴定理算法十分得快

- 分离轴定理算法十分得准

- 分离轴定理算法只适用于凸多边形，除非你把它们分成一些小的凸多边形，然后依次检验这些小的多边形。
- 分离轴定理算法无法告诉你是那条边发生的碰撞——仅仅是告诉你重叠了多少和分开它们所需的最短距离。

#### 凸特性

  如前所述，SAT是一种确定两个凸多边形是否相交的方法。如果某个形状与任何穿过该形状的直线只交叉两次，则该形状被称为凸多边形。如果某个形状与穿过该形状的直线交叉两次以上，则该形状为非凸（或凹）。

SAT指出：“**如果两个凸面物体没有穿透，则存在一根轴，使得这两个物体在该轴上的投影不重叠。**”

二维凸包，获取分离轴，**只要测试每个多边形的边的法线即可**



### eigen矩阵Affine3d

4*4，竖排拉成一行

![image-20230721150559987](C:/Users/Aking/AppData/Roaming/Typora/typora-user-images/image-20230721150559987.png)





